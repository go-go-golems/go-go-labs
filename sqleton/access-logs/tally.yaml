name: tally
short: Tally results by specified fields and JSON query fields with filters
flags:
  - name: by
    type: stringList
    help: Fields to tally results by
  - name: by_query
    type: stringList
    help: JSON fields in the 'query' column to extract and tally by
  - name: by_hour
    type: bool
    help: Group and tally results by hour
  - name: by_minute
    type: bool
    help: Group and tally results by minute

  - name: id
    type: intList
    help: List of log entry IDs
  - name: filename
    type: stringList
    help: Filter by exact filename(s)
  - name: filename_like
    type: stringList
    help: Filter by filename pattern(s)
  - name: db_host
    type: stringList
    help: Filter by host(s)
  - name: method
    type: stringList
    help: Filter by HTTP method(s)
  - name: process
    type: stringList
    help: Filter by process name(s)
  - name: query
    type: keyValue
    help: Filter by query key-value pair(s)
  - name: query_like
    type: stringList
    help: Filter by query pattern(s)
  - name: referer_like
    type: stringList
    help: Filter by referer URL pattern(s)
  - name: remote_ip
    type: stringList
    help: Filter by remote IP address(es)
  - name: request_like
    type: stringList
    help: Filter by request URL pattern(s)
  - name: status
    type: stringList
    help: Filter by HTTP status code(s)
  - name: unique_id
    type: stringList
    help: Filter by unique ID(s)
  - name: user_agent_like
    type: stringList
    help: Filter by user agent pattern(s)

  - name: from
    type: string
    help: Filter by minimum timestamp
  - name: to
    type: string
    help: Filter by maximum timestamp
  - name: limit
    type: int
    help: Limit number of results
    default: 10
  - name: offset
    type: int
    help: Offset results
    default: 0
query: |
  {{- if not (or .by .by_query .by_hour .by_minute) }}
  {{ fail "At least one of by, by_query, by_hour, or by_minute must be set" }}
  {{- end }}
  SELECT
    {{ $fieldOutput := false }}
    {{- if .by_hour }}
      {{- if $fieldOutput }}, {{ end }}{{ $fieldOutput = true }}
      strftime('%Y-%m-%d %H', datetime(time)) AS hour
    {{- end }}
    {{- if .by_minute }}
      {{- if $fieldOutput }}, {{ end }}{{ $fieldOutput = true }}
      strftime('%Y-%m-%d %H:%M', datetime(time)) AS minute
    {{- end }}
    {{ range $index, $field := .by }} 
    {{- if $fieldOutput }}, {{ end }}{{ $fieldOutput = true }}
    {{ $field }}{{ end }}
    {{- range $index, $field := .by_query }} 
      {{- if $fieldOutput}}, {{end}}{{ $fieldOutput = true }}
      json_extract(query, '$.{{ $field }}') AS {{ $field }} 
    {{- end }}
    , COUNT(*) AS tally
  FROM log_entries
  WHERE 1=1
  {{ if .id }}  
    AND id IN ({{ .id | sqlIntIn }})
  {{ end }}
  {{ if .filename }}
    AND filename IN ({{ .filename | sqlStringIn }}) 
  {{ end }}
  {{ if .filename_like }}
    AND (
      {{ range $index, $pattern := .filename_like }}
        {{ if $index }}OR {{ end }}filename LIKE {{ $pattern | sqlStringLike }}
      {{ end }}  
    )
  {{ end }}
  {{ if .db_host }}
    AND host IN ({{ .db_host | sqlStringIn }})
  {{ end }}
  {{ if .method }}
    AND method IN ({{ .method | sqlStringIn }})
  {{ end }}  
  {{ if .process }}
    AND process IN ({{ .process | sqlStringIn }})
  {{ end }}
    {{ if .query }}
    AND (
      1=1
      {{ range $key, $value := .query }}
            AND json_extract(query, '$.{{ $key }}') = '{{ $value }}'
      {{ end }}
    )
  {{ end }}
  {{ if .query_like }}  
    AND (
      {{ range $index, $pattern := .query_like }}
        {{ if $index }}OR {{ end }}query LIKE {{ $pattern | sqlStringLike }} 
      {{ end }}
    )  
  {{ end }}
  {{ if .referer_like }}
    AND (  
      {{ range $index, $pattern := .referer_like }}
        {{ if $index }}OR {{ end }}referer LIKE {{ $pattern | sqlStringLike }}
      {{ end }}
    )
  {{ end }}
  {{ if .remote_ip }}
    AND remoteIP IN ({{ .remote_ip | sqlStringIn }})
  {{ end }}
  {{ if .request_like }}
    AND (
      {{ range $index, $pattern := .request_like }} 
        {{ if $index }}OR {{ end }}request LIKE {{ $pattern | sqlStringLike }}
      {{ end }}  
    )
  {{ end }}
  {{ if .status }}
    AND status IN ({{ .status | sqlStringIn }}) 
  {{ end }}
  {{ if .from }}
    AND time >= '{{ .from }}'
  {{ end }}
  {{ if .to }}  
    AND time <= '{{ .to }}'
  {{ end }}
  {{ if .unique_id }}
    AND uniqueID IN ({{ .unique_id | sqlStringIn }})
  {{ end }}
  {{ if .user_agent_like }}
    AND (
      {{ range $index, $pattern := .user_agent_like }}
        {{ if $index }}OR {{ end }}userAgent LIKE {{ $pattern | sqlStringLike }} 
      {{ end }}
    )
  {{ end }}
  GROUP BY 
    {{ $fieldOutput = false }}
    {{ range $index, $field := .by }}
    {{- if $fieldOutput }}, {{ end }}{{ $fieldOutput = true }}
    {{ $field }}{{ end }}
    {{- range $index, $field := .by_query }}
    {{- if $fieldOutput }}, {{ end }}{{ $fieldOutput = true }}
     json_extract(query, '$.{{ $field }}')
    {{- end }}
    {{- if .by_hour }}
      {{- if $fieldOutput }}, {{ end }}{{ $fieldOutput = true }}
      strftime('%Y-%m-%d %H', datetime(time))
    {{- end }}
    {{- if .by_minute }}
      {{- if $fieldOutput }}, {{ end }}{{ $fieldOutput = true }}
      strftime('%Y-%m-%d %H:%M', datetime(time))
    {{- end }}
  ORDER BY tally DESC
  {{ if .limit }}
    LIMIT {{ .limit }}
  {{ end }}
  {{ if .offset }}
    OFFSET {{ .offset }}
  {{ end }}
